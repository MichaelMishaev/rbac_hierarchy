// Prisma Schema for Corporations MVP v1.4
// Premium UI Hierarchical Organization Management System
// FULLY COMPLIANT with v1.4 Specification

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS TABLE
// ============================================
model User {
  id String @id @default(uuid())

  // v1.4: Renamed fields
  email        String  @unique
  fullName     String  @map("full_name")
  phone        String?
  avatarUrl    String? @map("avatar_url")
  passwordHash String? @map("password_hash") // Nullable for external IdP support

  // Role (keep enum for convenience, v1.4 uses separate tables + is_super_admin flag)
  role Role @default(SUPERVISOR)

  // Status
  isActive     Boolean @default(true) @map("is_active")
  isSuperAdmin Boolean @default(false) @map("is_super_admin")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relations
  areaManager       AreaManager?         @relation("AreaManagerUser")
  managerOf         CorporationManager[]
  supervisorOf      Supervisor[] // v1.4: Renamed from SiteManager
  supervisorSites   SupervisorSite[]     @relation("SupervisorAssignments")
  invitationsSent   Invitation[]         @relation("InvitationCreator")
  tokens            UserToken[]          @relation("UserTokens")
  tasksSent         Task[]               @relation("TasksSent")
  tasksReceived     TaskAssignment[]     @relation("TasksReceived")
  pushSubscriptions PushSubscription[]   @relation("PushSubscriptions")

  @@index([email])
  @@index([isActive])
  @@index([isSuperAdmin])
  @@map("users")
}

enum Role {
  SUPERADMIN
  AREA_MANAGER
  MANAGER
  SUPERVISOR
}

// ============================================
// USER TOKENS TABLE (PASSWORD RESET, EMAIL CONFIRMATION)
// ============================================
model UserToken {
  id String @id @default(uuid())

  // Relationships
  userId String @map("user_id")
  user   User   @relation("UserTokens", fields: [userId], references: [id], onDelete: Cascade)

  // Token details
  type      TokenType
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@index([type])
  @@map("user_tokens")
}

enum TokenType {
  EMAIL_CONFIRMATION
  PASSWORD_RESET
}

// ============================================
// AREA MANAGERS TABLE
// ============================================
model AreaManager {
  id String @id @default(uuid())

  // Relationships
  userId String @unique @map("user_id")
  user   User   @relation("AreaManagerUser", fields: [userId], references: [id], onDelete: Cascade)

  // v1.4: region_code is NOT NULL and UNIQUE
  regionCode String @unique @map("region_code") // e.g., "IL-CENTER", "US-WEST"
  regionName String @map("region_name")         // Human-readable name

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Metadata
  metadata Json? @default("{}")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  corporations Corporation[]

  @@index([userId])
  @@index([isActive])
  @@index([regionName])
  @@index([regionCode])
  @@map("area_managers")
}

// ============================================
// CORPORATIONS TABLE
// ============================================
model Corporation {
  id          String  @id @default(uuid())
  name        String
  code        String  @unique // Short code (e.g., "ACME")
  description String?

  // v1.4: Renamed logo ‚Üí logoUrl, area_manager_id is NOT NULL
  logoUrl String? @map("logo_url")

  // v1.4: Area Manager is REQUIRED (NOT NULL)
  areaManagerId String      @map("area_manager_id")
  areaManager   AreaManager @relation(fields: [areaManagerId], references: [id], onDelete: Restrict)

  // Contact info (v1.4 includes these fields)
  email   String?
  phone   String?
  address String?

  // Settings
  isActive Boolean @default(true) @map("is_active")
  settings Json    @default("{}") // Corporation-level configuration
  metadata Json?                  // Flexible data storage

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  managers    CorporationManager[]
  supervisors Supervisor[] // v1.4: Renamed from SiteManager
  sites       Site[]
  invitations Invitation[]
  workers     Worker[]

  @@index([code])
  @@index([isActive])
  @@index([areaManagerId])
  @@map("corporations")
}

// ============================================
// CORPORATION MANAGERS TABLE
// ============================================
model CorporationManager {
  id String @id @default(uuid())

  // Relationships
  corporationId String      @map("corporation_id")
  corporation   Corporation @relation(fields: [corporationId], references: [id], onDelete: Cascade)

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Manager details
  title String? // Job title

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Metadata
  metadata Json? @default("{}")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([corporationId, userId]) // User can be manager once per corporation
  @@index([corporationId])
  @@index([userId])
  @@index([isActive])
  @@map("corporation_managers")
}

// ============================================
// SUPERVISORS TABLE (v1.4: Renamed from site_managers)
// ============================================
model Supervisor {
  id String @id @default(uuid())

  // Relationships
  corporationId String      @map("corporation_id")
  corporation   Corporation @relation(fields: [corporationId], references: [id], onDelete: Cascade)

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Supervisor details
  title String? // Job title

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Metadata
  metadata Json? @default("{}")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  siteAssignments SupervisorSite[]
  workers         Worker[] // v1.4: Workers can reference supervisor

  @@unique([corporationId, userId]) // User can be supervisor once per corporation
  @@unique([id, corporationId])     // v1.4 compliance: composite FK support
  @@index([corporationId])
  @@index([userId])
  @@index([isActive])
  @@map("supervisors") // v1.4: Changed from site_managers
}

// ============================================
// SITES TABLE
// ============================================
model Site {
  id   String  @id @default(uuid())
  name String

  // v1.4: Includes all these fields
  address String?
  city    String?
  country String? @default("Israel")

  // Geolocation (for map-based features)
  latitude  Float? // Decimal degrees
  longitude Float? // Decimal degrees

  // Contact
  phone String?
  email String?

  // Settings
  isActive Boolean @default(true) @map("is_active")
  metadata Json?                  // Flexible data storage

  // Relationships
  corporationId String      @map("corporation_id")
  corporation   Corporation @relation(fields: [corporationId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  supervisorAssignments SupervisorSite[]
  workers               Worker[]

  @@unique([id, corporationId]) // v1.4 compliance: composite FK support
  @@index([corporationId])
  @@index([isActive])
  @@map("sites")
}

// ============================================
// SUPERVISOR-SITE ASSIGNMENTS (M2M JOIN TABLE)
// ============================================
model SupervisorSite {
  id String @id @default(uuid())

  // v1.4 Compliance: Corporation ID for composite FK
  corporationId String @map("corporation_id")

  // v1.4: Relationships with composite FKs (references Supervisor, not SiteManager)
  supervisorId String     @map("supervisor_id")
  supervisor   Supervisor @relation(fields: [supervisorId, corporationId], references: [id, corporationId], onDelete: Cascade)

  siteId String @map("site_id")
  site   Site   @relation(fields: [siteId, corporationId], references: [id, corporationId], onDelete: Cascade)

  // Legacy: Keep user link for backward compatibility with existing code
  legacySupervisorUserId String @map("legacy_supervisor_user_id")
  legacySupervisorUser   User   @relation("SupervisorAssignments", fields: [legacySupervisorUserId], references: [id], onDelete: Cascade)

  // Assignment metadata
  assignedAt DateTime @default(now()) @map("assigned_at")
  assignedBy String?  @map("assigned_by") // User ID who made the assignment
  metadata   Json?    // v1.4 spec includes metadata

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([supervisorId, siteId]) // v1.4 composite PK (supervisor + site)
  @@index([legacySupervisorUserId])
  @@index([supervisorId])
  @@index([siteId])
  @@index([corporationId])
  @@map("supervisor_sites")
}

// ============================================
// WORKERS TABLE
// ============================================
model Worker {
  id String @id @default(uuid())

  // v1.4: Renamed name ‚Üí fullName, avatar ‚Üí avatarUrl
  fullName  String  @map("full_name")
  phone     String?
  email     String?
  position  String? // Job title
  avatarUrl String? @map("avatar_url")

  // Employment details (v1.4 includes these fields)
  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")
  isActive  Boolean   @default(true) @map("is_active")

  // Additional info (v1.4 includes these fields)
  notes    String?  // Supervisor notes
  tags     String[] @default([]) // Skills, certifications, etc.
  metadata Json?    // Flexible data storage

  // Relationships - CRITICAL: corporationId for data integrity
  corporationId String      @map("corporation_id")
  corporation   Corporation @relation(fields: [corporationId], references: [id], onDelete: Cascade)

  siteId String @map("site_id")
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // v1.4: supervisor_id is NULLABLE (worker can be temporarily unassigned)
  supervisorId String?     @map("supervisor_id")
  supervisor   Supervisor? @relation(fields: [supervisorId, corporationId], references: [id, corporationId], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // v1.4: Unique constraint on (site_id, full_name, phone)
  @@unique([siteId, fullName, phone])
  @@index([corporationId])
  @@index([siteId])
  @@index([supervisorId])
  @@index([isActive])
  @@index([phone])
  @@map("workers")
}

// ============================================
// INVITATIONS TABLE
// ============================================
model Invitation {
  id     String           @id @default(uuid())
  email  String
  role   Role
  status InvitationStatus @default(PENDING)
  token  String           @unique // Unique invitation token

  // Invitation details
  message   String? // Optional message to invitee
  expiresAt DateTime @map("expires_at")

  // Relationships
  corporationId String?      @map("corporation_id")
  corporation   Corporation? @relation(fields: [corporationId], references: [id], onDelete: Cascade)

  targetSiteId String? @map("target_site_id") // For site-specific supervisor invites

  createdById String @map("created_by_id")
  createdBy   User   @relation("InvitationCreator", fields: [createdById], references: [id], onDelete: Cascade)

  // Acceptance tracking
  acceptedAt DateTime? @map("accepted_at")

  // Metadata (v1.4: can store region info for Area Manager)
  metadata Json? @default("{}")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([token])
  @@index([status])
  @@index([corporationId])
  @@index([targetSiteId])
  @@map("invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ============================================
// AUDIT LOGS TABLE
// ============================================
model AuditLog {
  id       String @id @default(uuid())
  action   String // "CREATE", "UPDATE", "DELETE"
  entity   String // "Corporation", "User", "Site", "Worker"
  entityId String @map("entity_id")

  // v1.4: Renamed oldValue ‚Üí before, newValue ‚Üí after
  before Json? // JSON snapshot before change
  after  Json? // JSON snapshot after change

  // Actor
  userId    String? @map("user_id")
  userEmail String? @map("user_email")
  userRole  String? @map("user_role")

  // Context
  corporationId String? @map("corporation_id")
  ipAddress     String? @map("ip_address")
  userAgent     String? @map("user_agent")

  // Timestamp
  createdAt DateTime @default(now()) @map("created_at")

  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([userId])
  @@index([corporationId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// TASKS TABLE (v2.2: Task Broadcast System)
// ============================================
model Task {
  id   BigInt @id @default(autoincrement())
  type String @default("Task") // Hard-coded for v1.0, future: 'Announcement', 'Alert'
  body String // Task description/details

  // Sender relationship
  senderUserId String @map("sender_user_id")
  senderUser   User   @relation("TasksSent", fields: [senderUserId], references: [id], onDelete: Cascade)

  // Task details
  executionDate    DateTime @map("execution_date") @db.Date // When to execute (cannot be in past)
  recipientsCount  Int      @map("recipients_count") // ‚ö†Ô∏è NO DEFAULT - must be set explicitly

  // Soft delete
  deletedBySenderAt DateTime? @map("deleted_by_sender_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  assignments TaskAssignment[]

  @@index([senderUserId])
  @@index([executionDate])
  @@index([createdAt(sort: Desc)])
  @@index([deletedBySenderAt])
  @@map("tasks")
}

// ============================================
// TASK ASSIGNMENTS TABLE (v2.2: Task Broadcast System)
// ============================================
model TaskAssignment {
  id BigInt @id @default(autoincrement())

  // Relationships
  taskId       BigInt @map("task_id")
  task         Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  targetUserId String @map("target_user_id")
  targetUser   User   @relation("TasksReceived", fields: [targetUserId], references: [id], onDelete: Cascade)

  // Assignment status
  status         String    @default("unread") // unread/read/acknowledged/archived
  readAt         DateTime? @map("read_at")
  acknowledgedAt DateTime? @map("acknowledged_at")
  archivedAt     DateTime? @map("archived_at")

  // üö® CRITICAL: Sender deleted task (show greyed-out)
  deletedForRecipientAt DateTime? @map("deleted_for_recipient_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([taskId, targetUserId])
  @@index([targetUserId, status])
  @@index([taskId])
  @@index([targetUserId, archivedAt])
  @@index([deletedForRecipientAt])
  @@map("task_assignments")
}

// ============================================
// PUSH SUBSCRIPTIONS TABLE (PWA Support)
// ============================================
model PushSubscription {
  id       BigInt @id @default(autoincrement())

  // Relationships
  userId String @map("user_id")
  user   User   @relation("PushSubscriptions", fields: [userId], references: [id], onDelete: Cascade)

  // Push service details
  endpoint  String // Push service endpoint URL
  p256dh    String // Encryption key
  auth      String // Auth secret
  userAgent String? @map("user_agent") // Browser info

  // Timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")

  @@unique([userId, endpoint])
  @@index([userId])
  @@index([lastUsedAt])
  @@map("push_subscriptions")
}
