[build]
builder = "NIXPACKS"

[build.nixpacksPlan]
providers = ["node"]

# âš¡ Performance: Cache mount for faster rebuilds
[build.nixpacksCacheDirs]
paths = [
  "/app/app/node_modules",
  "/app/app/.next/cache"
]

[build.nixpacksCommands]
# Install dependencies (prisma generate runs in postinstall automatically)
install = "cd app && npm ci"
# Build the Next.js app (simplified - no duplicate Prisma, no prebuild hooks)
build = "cd app && npm run build"

[deploy]
# CRITICAL: Run migrations BEFORE app starts
# If this fails, deployment is aborted (safe!)
# 1. Run manual SQL migrations (session_events table)
# 2. Run Prisma migrations
preDeployCommand = "cd app && node scripts/railway-migrate.js && npx prisma migrate deploy"
# Start command for production
startCommand = "cd app && npm start"
# Restart policy
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

[deploy.healthcheck]
path = "/"
timeout = 100
interval = 10

# Service settings
[service]
# Root directory where package.json lives
rootDirectory = "app"
