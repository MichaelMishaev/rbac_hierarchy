name: CI - Regression Prevention

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      
      - name: Install dependencies
        working-directory: ./app
        run: npm ci
      
      - name: Run ESLint
        working-directory: ./app
        run: npm run lint
      
      - name: Run TypeScript type-check
        working-directory: ./app
        run: npm run type-check
        continue-on-error: true  # Temporarily allow failures (408 errors to fix)
  
  e2e-tests:
    name: E2E Critical Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres_test_password
          POSTGRES_DB: hierarchy_platform_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      
      - name: Install dependencies
        working-directory: ./app
        run: npm ci
      
      - name: Generate Prisma Client
        working-directory: ./app
        run: npm run db:generate
      
      - name: Push DB schema to test database
        working-directory: ./app
        run: npm run db:push
        env:
          DATABASE_URL: "postgresql://postgres:postgres_test_password@localhost:5432/hierarchy_platform_test"
          DATABASE_URL_POOLED: "postgresql://postgres:postgres_test_password@localhost:5432/hierarchy_platform_test?pgbouncer=true"
      
      - name: Seed test database
        working-directory: ./app
        run: npm run db:seed
        env:
          DATABASE_URL: "postgresql://postgres:postgres_test_password@localhost:5432/hierarchy_platform_test"
      
      - name: Install Playwright browsers
        working-directory: ./app
        run: npx playwright install --with-deps chromium
      
      - name: Run critical E2E tests
        working-directory: ./app
        run: npm run test:e2e -- tests/e2e/critical/
        env:
          DATABASE_URL: "postgresql://postgres:postgres_test_password@localhost:5432/hierarchy_platform_test"
          DATABASE_URL_POOLED: "postgresql://postgres:postgres_test_password@localhost:5432/hierarchy_platform_test?pgbouncer=true"
          BASE_URL: "http://localhost:3000"
          NEXTAUTH_SECRET: "test-secret-for-ci"
          NEXTAUTH_URL: "http://localhost:3000"
      
      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: app/playwright-report/
          retention-days: 7
      
      - name: Upload test screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: app/test-results/
          retention-days: 7
  
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, e2e-tests]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.lint-and-typecheck.result }}" == "success" ]; then
            echo "✅ Lint & Type Check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Lint & Type Check: FAILED (type errors expected)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "✅ E2E Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ E2E Tests: FAILED" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
